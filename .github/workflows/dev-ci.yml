name: Dev CI (Maven + Docker build + K8s lint)

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_dispatch:

concurrency:
  group: dev-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-java:
    name: Build & Test (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Maven package (with tests)
        run: mvn -B -DskipTests=false package

      - name: Publish surefire reports (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: '**/surefire-reports/**/*.xml'

  docker-build:
    name: Docker build (all services)
    needs: build-java
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - cloud-config
          - favourite-service
          - order-service
          - payment-service
          - product-service
          - proxy-client
          - service-discovery
          - shipping-service
          - user-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Maven package (skip tests)
        run: mvn -B -DskipTests=true package

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: false
          tags: local/${{ matrix.service }}:${{ github.sha }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  k8s-lint:
    name: K8s manifests lint (kustomize + kubeconform)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kustomize
        run: |
          curl -sSL https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Render manifests with kustomize
        run: |
          kustomize build k8s > k8s-rendered.yaml
          echo "Rendered manifests to k8s-rendered.yaml"

      - name: Install kubeconform (lint)
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz | sudo tar -xz -C /usr/local/bin kubeconform
          kubeconform -v

      - name: Validate manifests with kubeconform
        run: |
          kubeconform -schema-location default -strict -ignore-missing-schemas k8s-rendered.yaml

      - name: Upload rendered manifests (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: k8s-rendered
          path: k8s-rendered.yaml
