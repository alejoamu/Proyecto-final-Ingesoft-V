name: CI + E2E + Locust + Pages

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master, dev ]
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    outputs:
      site-path: ${{ steps.collect.outputs.site_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'

      - name: Build & run tests
        run: |
          ./mvnw -B -q -DskipTests=false test

      - name: Collect unit/integration reports into site
        id: collect
        run: |
          set -e
          SITE_DIR="site"
          mkdir -p "$SITE_DIR/unit-integration"
          # Copy all surefire reports
          find . -type d -path '*/target/surefire-reports' | while read -r d; do \
            m=$(echo "$d" | sed -E 's#\./([^/]+)/.*#\1#'); \
            out="$SITE_DIR/unit-integration/$m"; \
            mkdir -p "$out"; \
            cp -r "$d"/* "$out/" || true; \
          done
          # Build unit-integration index.html
          ui="$SITE_DIR/unit-integration/index.html"
          printf '%s\n' \
            '<html><head><meta charset="utf-8"><title>Unit & Integration Reports</title></head><body>' \
            '<h1>Unit & Integration (Surefire)</h1>' \
            '<ul>' > "$ui"
          # List modules and files
          find "$SITE_DIR/unit-integration" -mindepth 1 -maxdepth 1 -type d -print0 | while IFS= read -r -d '' mod; do \
            modname=$(basename "$mod"); \
            printf '%s\n' "<li><b>${modname}</b><ul>" >> "$ui"; \
            find "$mod" -maxdepth 1 -type f -name '*.xml' -print0 | while IFS= read -r -d '' f; do \
              # ruta relativa desde unit-integration/ (sin barra inicial)
              rel_module=${f#"$SITE_DIR/unit-integration/"}; \
              printf '%s\n' "<li><a href='${rel_module}'>$(basename \"$f\")</a></li>" >> \"$ui\"; \
            done; \
            printf '%s\n' '</ul></li>' >> "$ui"; \
          done
          printf '%s\n' '</ul></body></html>' >> "$ui"

          # Root index.html
          printf '%s\n' \
            '<html><head><meta charset="utf-8"><title>CI Reports</title></head><body>' \
            '<h1>Ecommerce Microservices - CI Reports</h1>' \
            '<ul>' \
            '  <li><a href="unit-integration/">Unit & Integration (Surefire)</a></li>' \
            '  <li><a href="e2e/">E2E Readiness</a></li>' \
            '  <li><a href="locust/">Locust Load Test</a></li>' \
            '</ul>' \
            '</body></html>' \
            > "$SITE_DIR/index.html"
          echo "site_path=$SITE_DIR" >> $GITHUB_OUTPUT

      - name: Upload site partial (unit/integration)
        uses: actions/upload-artifact@v4
        with:
          name: site-unit-integration
          path: site

  e2e-and-locust:
    name: E2E Readiness + Locust
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download site-unit-integration (merge)
        uses: actions/download-artifact@v4
        with:
          name: site-unit-integration
          path: site
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r tests/locust/requirements.txt
          python -c "import locust, sys; print('Locust:', locust.__version__)"

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: dev-e2e
          node_image: kindest/node:v1.30.0

      - name: Create namespace
        run: |
          kubectl get ns ecommerce || kubectl create ns ecommerce

      - name: Apply manifests
        run: |
          set -e
          kubectl apply -f k8s/namespace.yaml || true
          kubectl -n ecommerce apply -f k8s/service-discovery.yaml
          kubectl -n ecommerce apply -f k8s/cloud-config.yaml
          kubectl -n ecommerce apply -f k8s/zipkin.yaml || true
          kubectl -n ecommerce apply -f k8s/api-gateway.yaml || true
          kubectl -n ecommerce apply -f k8s/user-service.yaml
          kubectl -n ecommerce apply -f k8s/product-service.yaml
          kubectl -n ecommerce apply -f k8s/order-service.yaml
          kubectl -n ecommerce apply -f k8s/payment-service.yaml
          kubectl -n ecommerce apply -f k8s/shipping-service.yaml
          kubectl -n ecommerce apply -f k8s/favourite-service.yaml
          kubectl -n ecommerce apply -f k8s/proxy-client.yaml || true

      - name: Wait for core
        run: |
          set -e
          for d in service-discovery cloud-config; do
            kubectl -n ecommerce rollout status deploy/$d --timeout=240s || kubectl -n ecommerce get pods -o wide
          done

      - name: Wait for apps
        run: |
          set -e
          for d in user-service product-service order-service payment-service shipping-service favourite-service; do
            kubectl -n ecommerce rollout status deploy/$d --timeout=300s || kubectl -n ecommerce get pods -o wide
          done

      - name: Wait for service endpoints
        run: |
          set -e
          wait_ep() {
            svc=$1
            for i in $(seq 1 60); do
              ready=$(kubectl -n ecommerce get endpoints "$svc" -o jsonpath='{.subsets[*].addresses[*].ip}' || true)
              if [ -n "$ready" ]; then echo "Endpoints ready for $svc: $ready"; return 0; fi
              echo "[$i/60] waiting endpoints for $svc"; sleep 5
            done
            echo "ERROR: endpoints not ready for $svc"; kubectl -n ecommerce get endpoints "$svc" -o wide; exit 1
          }
          for s in product-service user-service shipping-service payment-service order-service favourite-service; do
            wait_ep "$s"
          done

      - name: Port-forward pods (background)
        run: |
          set -e
          # Obtiene un pod Running por etiqueta app
          pod_of() {
            kubectl -n ecommerce get pods -l app="$1" --field-selector=status.phase=Running -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | head -n 1
          }
          P_PRODUCT=$(pod_of product-service)
          P_USER=$(pod_of user-service)
          P_SHIP=$(pod_of shipping-service)
          P_PAY=$(pod_of payment-service)
          P_ORDER=$(pod_of order-service)
          P_FAV=$(pod_of favourite-service)
          echo "PF -> product: $P_PRODUCT, user: $P_USER, ship: $P_SHIP, pay: $P_PAY, order: $P_ORDER, fav: $P_FAV"

          # Lanzar port-forwards a pods en background y guardar PIDs en /tmp
          nohup kubectl -n ecommerce port-forward pod/$P_PRODUCT 8500:8500 >/dev/null 2>&1 & echo $! > /tmp/pf-product.pid
          nohup kubectl -n ecommerce port-forward pod/$P_USER    8700:8700 >/dev/null 2>&1 & echo $! > /tmp/pf-user.pid
          nohup kubectl -n ecommerce port-forward pod/$P_SHIP    8600:8600 >/dev/null 2>&1 & echo $! > /tmp/pf-ship.pid
          nohup kubectl -n ecommerce port-forward pod/$P_PAY     8400:8400 >/dev/null 2>&1 & echo $! > /tmp/pf-pay.pid
          nohup kubectl -n ecommerce port-forward pod/$P_ORDER   8300:8300 >/dev/null 2>&1 & echo $! > /tmp/pf-order.pid
          nohup kubectl -n ecommerce port-forward pod/$P_FAV     8800:8800 >/dev/null 2>&1 & echo $! > /tmp/pf-fav.pid

          # Esperar un poco a que los port-forwards estén activos
          sleep 300

      - name: E2E readiness checks (HTML)
        run: |
          set -e
          retry() { for i in $(seq 1 24); do curl -fsS "$1" && echo "\nOK: $1" && return 0; echo "Retry $i: $1"; sleep 5; done; return 1; }
          mkdir -p site/e2e
          {
            echo "<html><head><meta charset=\"utf-8\"><title>E2E Readiness</title></head><body>"
            echo "<h1>E2E Readiness Results</h1><ul>"
            for url in \
              http://localhost:8500/product-service/api/products \
              http://localhost:8700/user-service/api/users; do
                if retry "$url"; then
                  echo "<li><b>OK</b> $url</li>"
                else
                  echo "<li><b>FAIL</b> $url</li>"
                fi
            done
            # best effort para otros servicios
            for url in \
              http://localhost:8600/shipping-service/api/shippings \
              http://localhost:8400/payment-service/api/payments \
              http://localhost:8300/order-service/api/orders \
              http://localhost:8800/favourite-service/api/favourites; do
                if curl -fsS "$url" >/dev/null 2>&1; then
                  echo "<li><b>OK</b> $url</li>"
                else
                  echo "<li><b>WARN</b> $url</li>"
                fi
            done
            echo "</ul></body></html>"
          } > site/e2e/index.html

      - name: Run Locust (headless)
        env:
          PRODUCT_URL: http://localhost:8500/product-service/api/products
          USER_URL: http://localhost:8700/user-service/api/users
          SHIPPING_URL: http://localhost:8600/shipping-service/api/shippings
          PAYMENT_URL: http://localhost:8400/payment-service/api/payments
          ORDER_URL: http://localhost:8300/order-service/api/orders
          FAVOURITE_URL: http://localhost:8800/favourite-service/api/favourites
          BASE_HOST: http://localhost
        run: |
          python -m locust -f tests/locust/locustfile.py --host http://localhost --headless -u 50 -r 10 -t 1m --html locust-report.html --csv locust-results
          mkdir -p site/locust
          mv locust-report.html site/locust/
          mv locust-results* site/locust/
          # Build locust index.html
          printf '%s\n' \
            '<html><head><meta charset="utf-8"><title>Locust Reports</title></head><body>' \
            '<h1>Locust Load Test</h1>' \
            '<ul>' \
            '  <li><a href="locust-report.html">locust-report.html</a></li>' \
            '  <li><a href="locust-results_stats.csv">locust-results_stats.csv</a></li>' \
            '  <li><a href="locust-results_failures.csv">locust-results_failures.csv</a></li>' \
            '</ul>' \
            '</body></html>' \
            > site/locust/index.html

      - name: Ensure root index.html exists
        run: |
          if [ ! -f site/index.html ]; then
            printf '%s\n' \
              '<html><head><meta charset="utf-8"><title>CI Reports</title></head><body>' \
              '<h1>Ecommerce Microservices - CI Reports</h1>' \
              '<ul>' \
              '  <li><a href="unit-integration/">Unit & Integration (Surefire)</a></li>' \
              '  <li><a href="e2e/">E2E Readiness</a></li>' \
              '  <li><a href="locust/">Locust Load Test</a></li>' \
              '</ul>' \
              '</body></html>' \
              > site/index.html
          fi

      - name: Ensure 404 page exists
        run: |
          printf '%s\n' \
            '<html><head><meta charset="utf-8"><title>404 - Not Found</title></head><body>' \
            '<h1>404 - Página no encontrada</h1>' \
            '<p>Vuelve al <a href="/">inicio</a> o navega a:</p>' \
            '<ul>' \
            '  <li><a href="/unit-integration/">Unit & Integration</a></li>' \
            '  <li><a href="/e2e/">E2E Readiness</a></li>' \
            '  <li><a href="/locust/">Locust</a></li>' \
            '</ul>' \
            '</body></html>' \
            > site/404.html

      - name: List site content (diagnostic)
        run: |
          echo "== SITE CONTENT =="
          find site -maxdepth 3 -type f -printf '%P\n' | sort

      - name: Upload combined site
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Teardown
        if: always()
        run: |
          set +e
          for pid in /tmp/pf-*.pid; do [ -f "$pid" ] && kill $(cat "$pid") 2>/dev/null || true; done
          kind delete cluster --name dev-e2e

  deploy-pages:
    needs: [build-and-test, e2e-and-locust]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
