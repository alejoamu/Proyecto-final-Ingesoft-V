name: Dev E2E (K8s + Newman)

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_dispatch:

concurrency:
  group: dev-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-integration:
    name: Unit & Integration tests (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: m2-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            m2-${{ runner.os }}-

      - name: Run unit + integration tests
        run: mvn -B -DskipTests=false -Deureka.client.enabled=false -Dspring.cloud.config.enabled=false test

      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: '**/surefire-reports/**/*.xml'

  e2e:
    name: E2E tests with Newman on kind
    needs: unit-integration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install kind
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.23.0

      - name: Create kind cluster
        run: |
          kind create cluster --name dev-e2e --wait 120s
          kubectl version --client -o yaml
          kubectl get nodes -o wide

      - name: Apply manifests (kustomize)
        run: |
          kubectl apply -k k8s
          # Esperar namespace
          kubectl get ns ecommerce

      - name: Wait for deployments Ready
        run: |
          set -e
          # Esperar hasta 240s por todos los deployments
          kubectl -n ecommerce wait --for=condition=available --timeout=240s deployment --all
          kubectl -n ecommerce get pods -o wide

      - name: Port-forward services to localhost
        run: |
          # Lanzar port-forwards en background
          nohup kubectl -n ecommerce port-forward svc/product-service 8500:8500 >/dev/null 2>&1 & echo $! > pf_product.pid
          nohup kubectl -n ecommerce port-forward svc/user-service 8700:8700 >/dev/null 2>&1 & echo $! > pf_user.pid
          nohup kubectl -n ecommerce port-forward svc/shipping-service 8600:8600 >/dev/null 2>&1 & echo $! > pf_shipping.pid
          nohup kubectl -n ecommerce port-forward svc/payment-service 8400:8400 >/dev/null 2>&1 & echo $! > pf_payment.pid
          nohup kubectl -n ecommerce port-forward svc/order-service 8300:8300 >/dev/null 2>&1 & echo $! > pf_order.pid
          nohup kubectl -n ecommerce port-forward svc/favourite-service 8800:8800 >/dev/null 2>&1 & echo $! > pf_favourite.pid
          sleep 5

      - name: Warm-up and readiness checks (retry)
        run: |
          set -e
          retry() { for i in $(seq 1 24); do curl -fsS "$1" && echo "\nOK: $1" && return 0; echo "Retry $i: $1"; sleep 5; done; return 1; }
          retry http://localhost:8500/product-service/api/products
          retry http://localhost:8700/user-service/api/users
          # Los siguientes pueden depender de otros servicios; intentamos pero no fallamos la preparaciÃ³n si devuelven !=200
          curl -fsS http://localhost:8600/shipping-service/api/shippings || true
          curl -fsS http://localhost:8400/payment-service/api/payments || true
          curl -fsS http://localhost:8300/order-service/api/orders || true
          curl -fsS http://localhost:8800/favourite-service/api/favourites || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman

      - name: Run Newman collection
        run: |
          newman run tests/postman/ecommerce-e2e.postman_collection.json \
            --reporters cli,junit \
            --reporter-junit-export newman-results.xml

      - name: Upload Newman report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-results
          path: newman-results.xml

      - name: Cleanup port-forwards and cluster
        if: always()
        run: |
          for f in pf_*.pid; do if [ -f "$f" ]; then kill $(cat "$f") 2>/dev/null || true; fi; done
          kind delete cluster --name dev-e2e || true
