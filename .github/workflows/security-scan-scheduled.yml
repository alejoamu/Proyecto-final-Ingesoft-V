name: Scheduled Security Scan

# DISABLED - Solo code-quality.yml está habilitado
on:
  # schedule:
  #   # Ejecutar cada día a las 2 AM UTC
  #   - cron: '0 2 * * *'
  workflow_dispatch:  # Permitir ejecución manual

jobs:
  vulnerability-scan:
    name: Daily Vulnerability Scan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - proxy-client
          - user-service
          - product-service
          - order-service
          - payment-service
          - shipping-service
          - favourite-service
          - cloud-config
          - service-discovery
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency-Check
        continue-on-error: true
        run: |
          echo "Running OWASP Dependency-Check for ${{ matrix.service }}..."
          ./mvnw org.owasp:dependency-check-maven:check \
            -pl ${{ matrix.service }} \
            -am \
            -DfailBuildOnCVSS=0 \
            -DautoUpdate=true \
            -Dformat=HTML \
            -Dformat=JSON \
            -Dformat=XML || echo "OWASP scan completed with vulnerabilities"
        env:
          JAVA_OPTS: "-Xmx2048m"

      - name: Upload OWASP Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-daily-${{ matrix.service }}-${{ github.run_number }}
          path: ${{ matrix.service }}/target/dependency-check-report.*
          retention-days: 90

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ matrix.service }}'
          format: 'sarif'
          output: 'trivy-fs-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs-${{ matrix.service }}.sarif'

      - name: Scan Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ matrix.service }}/Dockerfile'
          format: 'sarif'
          output: 'trivy-dockerfile-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Dockerfile scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-dockerfile-${{ matrix.service }}.sarif'

  container-image-scan:
    name: Container Image Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    strategy:
      fail-fast: false
      matrix:
        service:
          - api-gateway
          - proxy-client
          - user-service
          - product-service
          - order-service
          - payment-service
          - shipping-service
          - favourite-service
          - cloud-config
          - service-discovery
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: false
          load: true
          tags: ${{ matrix.service }}:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.service }}:scan'
          format: 'sarif'
          output: 'trivy-image-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload image scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-image-${{ matrix.service }}.sarif'

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, container-image-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create security report
        run: |
          echo "# Security Scan Report - $(date)" > security-report.md
          echo "" >> security-report.md
          echo "## Scan Summary" >> security-report.md
          echo "- Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> security-report.md
          echo "- OWASP Dependency-Check: Completed" >> security-report.md
          echo "- Trivy Filesystem Scan: Completed" >> security-report.md
          echo "- Trivy Image Scan: Completed" >> security-report.md
          echo "" >> security-report.md
          echo "## Next Steps" >> security-report.md
          echo "1. Review uploaded SARIF reports in GitHub Security tab" >> security-report.md
          echo "2. Check OWASP reports in workflow artifacts" >> security-report.md
          echo "3. Address CRITICAL and HIGH severity vulnerabilities" >> security-report.md
          cat security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ github.run_number }}
          path: security-report.md
          retention-days: 90

