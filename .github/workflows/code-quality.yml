name: Code Quality & Security

on:
  pull_request:
    paths:
      - '**/*.java'
      - 'pom.xml'
      - '.github/workflows/code-quality.yml'
  push:
    branches: [ main, master ]

jobs:
  build-test-sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & Test
        run: ./mvnw -B clean verify -DskipTests=false -DfailIfNoTests=false

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: ./mvnw -B sonar:sonar -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} -Dsonar.login=${{ secrets.SONAR_TOKEN }} -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}

  security-scan:
    runs-on: ubuntu-latest
    needs: build-test-sonar
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run OWASP Dependency-Check
        continue-on-error: true
        run: |
          echo "Running OWASP Dependency-Check for Maven dependencies..."
          ./mvnw -B org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7.0 \
            -DautoUpdate=true \
            -Dformat=HTML \
            -Dformat=JSON \
            -Dformat=XML
        env:
          JAVA_OPTS: "-Xmx2048m"

      - name: Upload OWASP Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
            **/target/dependency-check-report.xml
          retention-days: 30

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          trivy_version: 'latest'
          install_only: true

      - name: Run Trivy filesystem scan
        continue-on-error: true
        run: |
          trivy fs --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output trivy-fs-report.txt .

      - name: Upload Trivy filesystem report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-filesystem-report
          path: trivy-fs-report.txt
          retention-days: 30

      - name: Build images matrix
        continue-on-error: true
        run: |
          for dir in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if [ -f "$dir/Dockerfile" ]; then
              docker build -q -t "$dir:ci-scan" "$dir" || echo "Failed to build $dir"
            fi
          done

      - name: Run Trivy image scans
        continue-on-error: true
        run: |
          for img in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if docker image inspect "$img:ci-scan" > /dev/null 2>&1; then
              echo "Scanning image: $img:ci-scan"
              trivy image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output "trivy-image-$img-report.txt" "$img:ci-scan" || echo "Scan failed for $img"
            fi
          done

      - name: Upload Trivy image reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-reports
          path: trivy-image-*-report.txt
          retention-days: 30
          if-no-files-found: ignore

