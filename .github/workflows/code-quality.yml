name: Code Quality & Security

on:
  pull_request:
    paths:
      - '**/*.java'
      - 'pom.xml'
      - '.github/workflows/code-quality.yml'
  push:
    branches: [ main, master ]

jobs:
  build-test-sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & Test
        run: ./mvnw -B clean verify -DskipTests=false -DfailIfNoTests=false

      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: ./mvnw -B sonar:sonar -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} -Dsonar.login=${{ secrets.SONAR_TOKEN }} -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}

      - name: Wait for SonarQube analysis to complete
        run: |
          echo "Waiting for SonarQube analysis to complete..."
          SONAR_HOST="${{ secrets.SONAR_HOST_URL }}"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}"
          PROJECT_KEY="ecommerce-microservice-backend"
          
          # Obtener el projectKey del pom.xml o usar el default
          if [ -f pom.xml ]; then
            PROJECT_KEY=$(grep -oP '<sonar.projectKey>\K[^<]+' pom.xml || echo "ecommerce-microservice-backend")
          fi
          
          MAX_WAIT=300  # 5 minutos máximo
          ELAPSED=0
          INTERVAL=5
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(curl -s -u "${SONAR_TOKEN}:" \
              "${SONAR_HOST}/api/ce/activity?component=${PROJECT_KEY}&status=SUCCESS,FAILED,CANCELED" \
              | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Analysis completed successfully!"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "Analysis failed or was canceled"
              break
            fi
            
            echo "Waiting for analysis to complete... (${ELAPSED}s/${MAX_WAIT}s)"
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done

      - name: Generate SonarQube PDF Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          echo "Generating SonarQube PDF Report..."
          
          # Instalar dependencias para generar PDF
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip wkhtmltopdf
          pip3 install requests reportlab
          
          SONAR_HOST="${{ secrets.SONAR_HOST_URL }}"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}"
          PROJECT_KEY="ecommerce-microservice-backend"
          
          # Obtener el projectKey del pom.xml
          if [ -f pom.xml ]; then
            PROJECT_KEY=$(grep -oP '<sonar.projectKey>\K[^<]+' pom.xml || echo "ecommerce-microservice-backend")
          fi
          
          # Crear script Python para generar PDF
          cat > generate_sonar_pdf.py << 'PYTHON_SCRIPT'
          import requests
          import json
          from reportlab.lib.pagesizes import letter, A4
          from reportlab.lib import colors
          from reportlab.lib.units import inch
          from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
          from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
          from reportlab.lib.enums import TA_CENTER, TA_LEFT
          from datetime import datetime
          import sys
          
          SONAR_HOST = sys.argv[1]
          SONAR_TOKEN = sys.argv[2]
          PROJECT_KEY = sys.argv[3]
          
          auth = (SONAR_TOKEN, '')
          base_url = f"{SONAR_HOST}/api"
          
          # Obtener métricas del proyecto
          print("Fetching project metrics...")
          metrics_url = f"{base_url}/measures/component"
          metrics_params = {
              'component': PROJECT_KEY,
              'metricKeys': 'coverage,duplicated_lines_density,bugs,vulnerabilities,code_smells,security_hotspots,sqale_index,ncloc,reliability_rating,security_rating,sqale_rating'
          }
          
          try:
              response = requests.get(metrics_url, params=metrics_params, auth=auth, timeout=30)
              response.raise_for_status()
              measures_data = response.json()
              
              # Obtener información del proyecto
              project_url = f"{base_url}/project_analyses/search"
              project_params = {'project': PROJECT_KEY}
              project_response = requests.get(project_url, params=project_params, auth=auth, timeout=30)
              project_info = project_response.json() if project_response.status_code == 200 else {}
              
              # Crear PDF
              pdf_filename = 'sonarqube-report.pdf'
              doc = SimpleDocTemplate(pdf_filename, pagesize=A4)
              story = []
              
              # Estilos
              styles = getSampleStyleSheet()
              title_style = ParagraphStyle(
                  'CustomTitle',
                  parent=styles['Heading1'],
                  fontSize=24,
                  textColor=colors.HexColor('#4A90E2'),
                  spaceAfter=30,
                  alignment=TA_CENTER
              )
              
              heading_style = ParagraphStyle(
                  'CustomHeading',
                  parent=styles['Heading2'],
                  fontSize=16,
                  textColor=colors.HexColor('#2C3E50'),
                  spaceAfter=12
              )
              
              # Título
              story.append(Paragraph("SonarQube Quality Report", title_style))
              story.append(Spacer(1, 0.2*inch))
              
              # Información del proyecto
              story.append(Paragraph(f"<b>Project:</b> {PROJECT_KEY}", styles['Normal']))
              story.append(Paragraph(f"<b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
              story.append(Spacer(1, 0.3*inch))
              
              # Métricas
              story.append(Paragraph("Quality Metrics", heading_style))
              
              # Preparar datos de la tabla
              measures = measures_data.get('component', {}).get('measures', [])
              metric_data = []
              metric_data.append(['Metric', 'Value'])
              
              metric_labels = {
                  'coverage': 'Code Coverage (%)',
                  'duplicated_lines_density': 'Duplicated Lines (%)',
                  'bugs': 'Bugs',
                  'vulnerabilities': 'Vulnerabilities',
                  'code_smells': 'Code Smells',
                  'security_hotspots': 'Security Hotspots',
                  'sqale_index': 'Technical Debt (minutes)',
                  'ncloc': 'Lines of Code',
                  'reliability_rating': 'Reliability Rating',
                  'security_rating': 'Security Rating',
                  'sqale_rating': 'Maintainability Rating'
              }
              
              for measure in measures:
                  metric_key = measure.get('metric', '')
                  metric_value = measure.get('value', 'N/A')
                  if metric_key in metric_labels:
                      label = metric_labels[metric_key]
                      # Formatear valores
                      if metric_key in ['coverage', 'duplicated_lines_density']:
                          metric_value = f"{float(metric_value):.2f}%" if metric_value != 'N/A' else 'N/A'
                      elif metric_key == 'sqale_index':
                          hours = int(metric_value) // 60 if metric_value != 'N/A' else 0
                          minutes = int(metric_value) % 60 if metric_value != 'N/A' else 0
                          metric_value = f"{hours}h {minutes}m" if metric_value != 'N/A' else 'N/A'
                      metric_data.append([label, str(metric_value)])
              
              # Crear tabla
              table = Table(metric_data, colWidths=[4*inch, 2*inch])
              table.setStyle(TableStyle([
                  ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#4A90E2')),
                  ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                  ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                  ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                  ('FONTSIZE', (0, 0), (-1, 0), 12),
                  ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                  ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                  ('GRID', (0, 0), (-1, -1), 1, colors.black),
                  ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
              ]))
              
              story.append(table)
              story.append(Spacer(1, 0.3*inch))
              
              # Información adicional
              story.append(Paragraph("Report Information", heading_style))
              story.append(Paragraph(f"<b>SonarQube URL:</b> {SONAR_HOST}", styles['Normal']))
              story.append(Paragraph(f"<b>Project URL:</b> {SONAR_HOST}/dashboard?id={PROJECT_KEY}", styles['Normal']))
              
              # Construir PDF
              doc.build(story)
              print(f"PDF report generated: {pdf_filename}")
              
          except Exception as e:
              print(f"Error generating PDF: {str(e)}")
              sys.exit(1)
          PYTHON_SCRIPT
          
          python3 generate_sonar_pdf.py "$SONAR_HOST" "$SONAR_TOKEN" "$PROJECT_KEY"

      - name: Upload SonarQube PDF Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sonarqube-pdf-report
          path: sonarqube-report.pdf
          retention-days: 30
          if-no-files-found: ignore

  security-scan:
    runs-on: ubuntu-latest
    needs: build-test-sonar
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run OWASP Dependency-Check
        continue-on-error: true
        run: |
          echo "Running OWASP Dependency-Check for Maven dependencies..."
          ./mvnw -B org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7.0 \
            -DautoUpdate=true \
            -Dformat=HTML \
            -Dformat=JSON \
            -Dformat=XML
        env:
          JAVA_OPTS: "-Xmx2048m"

      - name: Upload OWASP Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
            **/target/dependency-check-report.xml
          retention-days: 30

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar -xz
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Run Trivy filesystem scan
        continue-on-error: true
        run: |
          trivy fs --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output trivy-fs-report.txt .

      - name: Upload Trivy filesystem report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-filesystem-report
          path: trivy-fs-report.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Build images matrix
        continue-on-error: true
        run: |
          for dir in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if [ -f "$dir/Dockerfile" ]; then
              docker build -q -t "$dir:ci-scan" "$dir" || echo "Failed to build $dir"
            fi
          done

      - name: Run Trivy image scans
        continue-on-error: true
        run: |
          for img in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if docker image inspect "$img:ci-scan" > /dev/null 2>&1; then
              echo "Scanning image: $img:ci-scan"
              trivy image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output "trivy-image-$img-report.txt" "$img:ci-scan" || echo "Scan failed for $img"
            fi
          done

      - name: Upload Trivy image reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-reports
          path: trivy-image-*-report.txt
          retention-days: 30
          if-no-files-found: ignore

