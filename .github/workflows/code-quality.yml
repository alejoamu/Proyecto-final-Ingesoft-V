name: Code Quality & Security

on:
  pull_request:
    paths:
      - '**/*.java'
      - 'pom.xml'
      - '.github/workflows/code-quality.yml'
  push:
    branches: [ main, master ]

jobs:
  build-test-sonar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Verificar que el token esté configurado
          if [ -z "$SONAR_TOKEN" ]; then
            echo "ERROR: SONAR_TOKEN secret is not set in GitHub Secrets"
            echo "Please configure it in: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          # Obtener el projectKey del sonar-project.properties o usar el default
          if [ -f sonar-project.properties ]; then
            PROJECT_KEY=$(grep "^sonar.projectKey=" sonar-project.properties | cut -d'=' -f2 | tail -1 || echo "alejoamu_Proyecto-final-Ingesoft-V")
            SONAR_ORG=$(grep "^sonar.organization=" sonar-project.properties | cut -d'=' -f2 | tail -1 || echo "alejoamu")
          else
            PROJECT_KEY="alejoamu_Proyecto-final-Ingesoft-V"
            SONAR_ORG="alejoamu"
          fi
          
          echo "=== SonarCloud Configuration ==="
          echo "Project Key: $PROJECT_KEY"
          echo "Organization: $SONAR_ORG"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Repository: ${{ github.repository }}"
          echo "Token configured: $([ -n "$SONAR_TOKEN" ] && echo "Yes" || echo "No")"
          echo ""
          
          # Ejecutar build, tests y análisis de SonarQube
          # Formato exacto recomendado por SonarCloud para Maven
          echo "=== Running Maven build, tests and SonarCloud analysis ==="
          ./mvnw clean verify sonar:sonar \
            -Dsonar.projectKey=$PROJECT_KEY \
            -Dsonar.organization=$SONAR_ORG \
            -Dsonar.host.url=https://sonarcloud.io \
            -DskipTests=false \
            -DfailIfNoTests=false \
            -X || {
              echo ""
              echo "=== ERROR: Build, test or SonarCloud analysis failed ==="
              echo "Please check:"
              echo "  1. SONAR_TOKEN is valid and set in GitHub Secrets"
              echo "  2. SONAR_ORGANIZATION is correct: $SONAR_ORG"
              echo "  3. Project key '$PROJECT_KEY' exists in SonarCloud"
              echo "  4. Token has permissions to analyze this project"
              echo "  5. Build and tests completed successfully"
              echo ""
              echo "To verify your SonarCloud setup:"
              echo "  - Go to https://sonarcloud.io/projects"
              echo "  - Check if project '$PROJECT_KEY' exists"
              echo "  - Verify token permissions in SonarCloud > My Account > Security"
              exit 1
            }
          
          echo ""
          echo "=== ✓ Build, tests and SonarCloud analysis completed successfully ==="
          echo "View results at: https://sonarcloud.io/project/overview?id=$PROJECT_KEY"

      - name: Wait for SonarQube analysis to complete
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "=== Waiting for SonarCloud analysis to complete ==="
          SONAR_HOST="https://sonarcloud.io"
          
          # Obtener el projectKey del sonar-project.properties o usar el default
          if [ -f sonar-project.properties ]; then
            PROJECT_KEY=$(grep "^sonar.projectKey=" sonar-project.properties | cut -d'=' -f2 | tail -1 || echo "alejoamu_Proyecto-final-Ingesoft-V")
          else
            PROJECT_KEY="alejoamu_Proyecto-final-Ingesoft-V"
          fi
          
          echo "Project Key: $PROJECT_KEY"
          echo "SonarCloud URL: $SONAR_HOST"
          
          MAX_WAIT=600  # 10 minutos máximo
          ELAPSED=0
          INTERVAL=10
          
          echo "Polling SonarCloud API for analysis status..."
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Obtener el estado del análisis más reciente
            CE_RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" \
              "${SONAR_HOST}/api/ce/activity?component=${PROJECT_KEY}&ps=1" || echo "")
            
            if [ -z "$CE_RESPONSE" ]; then
              echo "[${ELAPSED}s/${MAX_WAIT}s] No response from SonarCloud API, retrying..."
              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
              continue
            fi
            
            STATUS=$(echo "$CE_RESPONSE" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "✓ Analysis completed successfully!"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "✗ Analysis failed or was canceled (status: $STATUS)"
              break
            else
              echo "[${ELAPSED}s/${MAX_WAIT}s] Analysis in progress (status: ${STATUS:-PENDING})..."
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "⚠️  Timeout waiting for analysis to complete"
            echo "The analysis may still be processing. PDF generation will attempt to proceed."
          fi

      - name: Generate SonarQube PDF Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true
        run: |
          echo "=== Generating SonarQube PDF Report ==="
          
          # Instalar dependencias para generar PDF
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install requests reportlab
          
          SONAR_HOST="https://sonarcloud.io"
          SONAR_TOKEN="${{ secrets.SONAR_TOKEN }}"
          
          # Obtener el projectKey del sonar-project.properties o usar el default
          if [ -f sonar-project.properties ]; then
            PROJECT_KEY=$(grep "^sonar.projectKey=" sonar-project.properties | cut -d'=' -f2 | tail -1 || echo "alejoamu_Proyecto-final-Ingesoft-V")
          else
            PROJECT_KEY="alejoamu_Proyecto-final-Ingesoft-V"
          fi
          
          echo "Using project key for PDF: $PROJECT_KEY"
          echo "SonarQube host: $SONAR_HOST"
          
          # Crear script Python para generar PDF
          cat > generate_sonar_pdf.py << 'PYTHON_SCRIPT'
          import requests
          import json
          from reportlab.lib.pagesizes import letter, A4
          from reportlab.lib import colors
          from reportlab.lib.units import inch
          from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer, PageBreak
          from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
          from reportlab.lib.enums import TA_CENTER, TA_LEFT
          from datetime import datetime
          import sys
          
          SONAR_HOST = sys.argv[1]
          SONAR_TOKEN = sys.argv[2]
          PROJECT_KEY = sys.argv[3]
          
          auth = (SONAR_TOKEN, '')
          base_url = f"{SONAR_HOST}/api"
          
          # Obtener métricas del proyecto
          print("Fetching project metrics...")
          metrics_url = f"{base_url}/measures/component"
          metrics_params = {
              'component': PROJECT_KEY,
              'metricKeys': 'coverage,duplicated_lines_density,bugs,vulnerabilities,code_smells,security_hotspots,sqale_index,ncloc,reliability_rating,security_rating,sqale_rating'
          }
          
          try:
              # Primero verificar que el proyecto existe
              print(f"Checking if project exists: {PROJECT_KEY}")
              search_url = f"{base_url}/projects/search"
              search_params = {'q': PROJECT_KEY}
              search_response = requests.get(search_url, params=search_params, auth=auth, timeout=30)
              
              if search_response.status_code == 404:
                  print(f"ERROR: Project '{PROJECT_KEY}' not found in SonarCloud")
                  print("Available projects:")
                  all_projects = requests.get(search_url, params={'ps': 100}, auth=auth, timeout=30)
                  if all_projects.status_code == 200:
                      projects = all_projects.json().get('components', [])
                      for proj in projects[:10]:
                          print(f"  - {proj.get('key', 'N/A')}: {proj.get('name', 'N/A')}")
                  sys.exit(1)
              
              # Intentar obtener métricas con varios intentos
              max_retries = 3
              retry_delay = 10
              measures_data = None
              
              for attempt in range(max_retries):
                  response = requests.get(metrics_url, params=metrics_params, auth=auth, timeout=30)
                  
                  if response.status_code == 200:
                      measures_data = response.json()
                      measures = measures_data.get('component', {}).get('measures', [])
                      if measures:
                          print(f"✓ Successfully retrieved {len(measures)} metrics")
                          break
                      else:
                          print(f"Attempt {attempt + 1}: Got response but no measures found")
                  elif response.status_code == 404:
                      print(f"Attempt {attempt + 1}: Project not found or no analysis data (404)")
                      if attempt < max_retries - 1:
                          print(f"Waiting {retry_delay}s before retry...")
                          time.sleep(retry_delay)
                          continue
                  else:
                      print(f"Attempt {attempt + 1}: HTTP {response.status_code}")
                      if attempt < max_retries - 1:
                          print(f"Waiting {retry_delay}s before retry...")
                          time.sleep(retry_delay)
                          continue
                  
                  if attempt == max_retries - 1:
                      # Último intento falló
                      if response.status_code == 404:
                          print(f"ERROR: Project '{PROJECT_KEY}' not found or has no analysis data")
                          print(f"Please check: {SONAR_HOST}/dashboard?id={PROJECT_KEY}")
                          print("Creating PDF with error message...")
                          pdf_filename = 'sonarqube-report.pdf'
                          doc = SimpleDocTemplate(pdf_filename, pagesize=A4)
                          story = []
                          styles = getSampleStyleSheet()
                          title_style = ParagraphStyle('CustomTitle', parent=styles['Heading1'], fontSize=24, textColor=colors.HexColor('#FF6B6B'), spaceAfter=30, alignment=TA_CENTER)
                          story.append(Paragraph("SonarQube Quality Report", title_style))
                          story.append(Paragraph(f"<b>Project:</b> {PROJECT_KEY}", styles['Normal']))
                          story.append(Paragraph(f"<b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
                          story.append(Spacer(1, 0.2*inch))
                          story.append(Paragraph("<b>Status:</b> <font color='red'>No analysis data available</font>", styles['Normal']))
                          story.append(Paragraph("The project may need to be analyzed first or the analysis is still processing.", styles['Normal']))
                          story.append(Spacer(1, 0.2*inch))
                          story.append(Paragraph(f"<b>Project URL:</b> {SONAR_HOST}/dashboard?id={PROJECT_KEY}", styles['Normal']))
                          story.append(Paragraph(f"<b>Organization:</b> alejoamu", styles['Normal']))
                          doc.build(story)
                          print(f"PDF report generated (no data): {pdf_filename}")
                          sys.exit(0)
                      else:
                          response.raise_for_status()
              
              if not measures_data:
                  raise Exception("Failed to retrieve metrics after all retries")
              
              response.raise_for_status()
              
              # Obtener información del proyecto
              project_url = f"{base_url}/project_analyses/search"
              project_params = {'project': PROJECT_KEY}
              project_response = requests.get(project_url, params=project_params, auth=auth, timeout=30)
              project_info = project_response.json() if project_response.status_code == 200 else {}
              
              # Crear PDF
              pdf_filename = 'sonarqube-report.pdf'
              doc = SimpleDocTemplate(pdf_filename, pagesize=A4)
              story = []
              
              # Estilos
              styles = getSampleStyleSheet()
              title_style = ParagraphStyle(
                  'CustomTitle',
                  parent=styles['Heading1'],
                  fontSize=24,
                  textColor=colors.HexColor('#4A90E2'),
                  spaceAfter=30,
                  alignment=TA_CENTER
              )
              
              heading_style = ParagraphStyle(
                  'CustomHeading',
                  parent=styles['Heading2'],
                  fontSize=16,
                  textColor=colors.HexColor('#2C3E50'),
                  spaceAfter=12
              )
              
              # Título
              story.append(Paragraph("SonarQube Quality Report", title_style))
              story.append(Spacer(1, 0.2*inch))
              
              # Información del proyecto
              story.append(Paragraph(f"<b>Project:</b> {PROJECT_KEY}", styles['Normal']))
              story.append(Paragraph(f"<b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
              story.append(Spacer(1, 0.3*inch))
              
              # Métricas
              story.append(Paragraph("Quality Metrics", heading_style))
              
              # Preparar datos de la tabla
              measures = measures_data.get('component', {}).get('measures', [])
              metric_data = []
              metric_data.append(['Metric', 'Value'])
              
              metric_labels = {
                  'coverage': 'Code Coverage (%)',
                  'duplicated_lines_density': 'Duplicated Lines (%)',
                  'bugs': 'Bugs',
                  'vulnerabilities': 'Vulnerabilities',
                  'code_smells': 'Code Smells',
                  'security_hotspots': 'Security Hotspots',
                  'sqale_index': 'Technical Debt (minutes)',
                  'ncloc': 'Lines of Code',
                  'reliability_rating': 'Reliability Rating',
                  'security_rating': 'Security Rating',
                  'sqale_rating': 'Maintainability Rating'
              }
              
              for measure in measures:
                  metric_key = measure.get('metric', '')
                  metric_value = measure.get('value', 'N/A')
                  if metric_key in metric_labels:
                      label = metric_labels[metric_key]
                      # Formatear valores
                      if metric_key in ['coverage', 'duplicated_lines_density']:
                          metric_value = f"{float(metric_value):.2f}%" if metric_value != 'N/A' else 'N/A'
                      elif metric_key == 'sqale_index':
                          hours = int(metric_value) // 60 if metric_value != 'N/A' else 0
                          minutes = int(metric_value) % 60 if metric_value != 'N/A' else 0
                          metric_value = f"{hours}h {minutes}m" if metric_value != 'N/A' else 'N/A'
                      metric_data.append([label, str(metric_value)])
              
              # Crear tabla
              table = Table(metric_data, colWidths=[4*inch, 2*inch])
              table.setStyle(TableStyle([
                  ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#4A90E2')),
                  ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                  ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                  ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                  ('FONTSIZE', (0, 0), (-1, 0), 12),
                  ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                  ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
                  ('GRID', (0, 0), (-1, -1), 1, colors.black),
                  ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
              ]))
              
              story.append(table)
              story.append(Spacer(1, 0.3*inch))
              
              # Información adicional
              story.append(Paragraph("Report Information", heading_style))
              story.append(Paragraph(f"<b>SonarQube URL:</b> {SONAR_HOST}", styles['Normal']))
              story.append(Paragraph(f"<b>Project URL:</b> {SONAR_HOST}/dashboard?id={PROJECT_KEY}", styles['Normal']))
              
              # Construir PDF
              doc.build(story)
              print(f"PDF report generated: {pdf_filename}")
              
          except requests.exceptions.HTTPError as e:
              print(f"HTTP Error: {e.response.status_code} - {str(e)}")
              if e.response.status_code == 404:
                  print(f"Project '{PROJECT_KEY}' not found or has no analysis data")
                  # Crear PDF básico con mensaje de error
                  pdf_filename = 'sonarqube-report.pdf'
                  doc = SimpleDocTemplate(pdf_filename, pagesize=A4)
                  story = []
                  styles = getSampleStyleSheet()
                  story.append(Paragraph("SonarQube Quality Report", styles['Heading1']))
                  story.append(Paragraph(f"<b>Project:</b> {PROJECT_KEY}", styles['Normal']))
                  story.append(Paragraph(f"<b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
                  story.append(Spacer(1, 0.2*inch))
                  story.append(Paragraph("<b>Status:</b> Error - Project not found or no analysis data", styles['Normal']))
                  story.append(Paragraph(f"<b>Error:</b> HTTP {e.response.status_code}", styles['Normal']))
                  story.append(Spacer(1, 0.2*inch))
                  story.append(Paragraph(f"<b>Project URL:</b> {SONAR_HOST}/dashboard?id={PROJECT_KEY}", styles['Normal']))
                  doc.build(story)
                  print(f"PDF report generated (error): {pdf_filename}")
                  sys.exit(0)
              else:
                  raise
          except Exception as e:
              print(f"Error generating PDF: {str(e)}")
              import traceback
              traceback.print_exc()
              # Crear PDF básico de error
              try:
                  pdf_filename = 'sonarqube-report.pdf'
                  doc = SimpleDocTemplate(pdf_filename, pagesize=A4)
                  story = []
                  styles = getSampleStyleSheet()
                  story.append(Paragraph("SonarQube Quality Report", styles['Heading1']))
                  story.append(Paragraph(f"<b>Project:</b> {PROJECT_KEY}", styles['Normal']))
                  story.append(Paragraph(f"<b>Date:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", styles['Normal']))
                  story.append(Spacer(1, 0.2*inch))
                  story.append(Paragraph("<b>Status:</b> Error generating report", styles['Normal']))
                  story.append(Paragraph(f"<b>Error:</b> {str(e)[:200]}", styles['Normal']))
                  doc.build(story)
                  print(f"Basic error PDF created: {pdf_filename}")
              except:
                  pass
              sys.exit(1)
          PYTHON_SCRIPT
          
          echo "Executing PDF generation script..."
          python3 generate_sonar_pdf.py "$SONAR_HOST" "$SONAR_TOKEN" "$PROJECT_KEY" || {
            echo "WARNING: PDF generation encountered an error, but a basic PDF may have been created"
          }

      - name: Upload SonarQube PDF Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sonarqube-pdf-report
          path: sonarqube-report.pdf
          retention-days: 30
          if-no-files-found: ignore

  security-scan:
    runs-on: ubuntu-latest
    needs: build-test-sonar
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Run OWASP Dependency-Check
        continue-on-error: true
        run: |
          echo "Running OWASP Dependency-Check for Maven dependencies..."
          ./mvnw -B org.owasp:dependency-check-maven:check \
            -DfailBuildOnCVSS=7.0 \
            -DautoUpdate=true \
            -Dformat=HTML \
            -Dformat=JSON \
            -Dformat=XML
        env:
          JAVA_OPTS: "-Xmx2048m"

      - name: Upload OWASP Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
            **/target/dependency-check-report.xml
          retention-days: 30

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz | tar -xz
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Run Trivy filesystem scan
        continue-on-error: true
        run: |
          trivy fs --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output trivy-fs-report.txt .

      - name: Upload Trivy filesystem report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-filesystem-report
          path: trivy-fs-report.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Build images matrix
        continue-on-error: true
        run: |
          for dir in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if [ -f "$dir/Dockerfile" ]; then
              docker build -q -t "$dir:ci-scan" "$dir" || echo "Failed to build $dir"
            fi
          done

      - name: Run Trivy image scans
        continue-on-error: true
        run: |
          for img in api-gateway proxy-client user-service product-service favourite-service order-service shipping-service payment-service cloud-config service-discovery; do
            if docker image inspect "$img:ci-scan" > /dev/null 2>&1; then
              echo "Scanning image: $img:ci-scan"
              trivy image --severity HIGH,CRITICAL --ignore-unfixed --exit-code 0 --format table --output "trivy-image-$img-report.txt" "$img:ci-scan" || echo "Scan failed for $img"
            fi
          done

      - name: Upload Trivy image reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-reports
          path: trivy-image-*-report.txt
          retention-days: 30
          if-no-files-found: ignore

