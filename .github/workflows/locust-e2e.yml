name: Dev E2E - Locust

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_dispatch: {}

jobs:
  e2e-locust:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust deps
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/locust/requirements.txt

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: dev-e2e
          node_image: kindest/node:v1.30.0

      - name: Create namespace
        run: |
          kubectl get ns ecommerce || kubectl create ns ecommerce

      - name: Apply K8s manifests
        run: |
          # Apply namespace-scoped resources
          kubectl -n ecommerce apply -f k8s/service-discovery.yaml
          kubectl -n ecommerce apply -f k8s/cloud-config.yaml
          kubectl -n ecommerce apply -f k8s/zipkin.yaml || true
          kubectl -n ecommerce apply -f k8s/api-gateway.yaml || true
          kubectl -n ecommerce apply -f k8s/user-service.yaml
          kubectl -n ecommerce apply -f k8s/product-service.yaml
          kubectl -n ecommerce apply -f k8s/order-service.yaml
          kubectl -n ecommerce apply -f k8s/payment-service.yaml
          kubectl -n ecommerce apply -f k8s/shipping-service.yaml
          kubectl -n ecommerce apply -f k8s/favourite-service.yaml
          kubectl -n ecommerce apply -f k8s/proxy-client.yaml || true

      - name: Wait for core infra
        run: |
          set -e
          for d in service-discovery cloud-config; do
            echo "Waiting for $d"
            kubectl -n ecommerce rollout status deploy/$d --timeout=180s || kubectl -n ecommerce get pods -o wide
          done

      - name: Wait for apps
        run: |
          set -e
          for d in user-service product-service order-service payment-service shipping-service favourite-service; do
            echo "Waiting for $d"
            kubectl -n ecommerce rollout status deploy/$d --timeout=240s || kubectl -n ecommerce get pods -o wide
          done

      - name: Port-forward Services
        run: |
          set -e
          # Forward service ports to localhost matching each service's internal port
          kubectl -n ecommerce port-forward svc/product-service 8500:8500 >/tmp/pf-product.log 2>&1 & echo $! > /tmp/pf-product.pid
          kubectl -n ecommerce port-forward svc/user-service 8700:8700   >/tmp/pf-user.log    2>&1 & echo $! > /tmp/pf-user.pid
          kubectl -n ecommerce port-forward svc/shipping-service 8600:8600 >/tmp/pf-ship.log   2>&1 & echo $! > /tmp/pf-ship.pid
          kubectl -n ecommerce port-forward svc/payment-service 8400:8400 >/tmp/pf-pay.log    2>&1 & echo $! > /tmp/pf-pay.pid
          kubectl -n ecommerce port-forward svc/order-service 8300:8300   >/tmp/pf-order.log  2>&1 & echo $! > /tmp/pf-order.pid
          kubectl -n ecommerce port-forward svc/favourite-service 8800:8800 >/tmp/pf-fav.log  2>&1 & echo $! > /tmp/pf-fav.pid
          sleep 3

      - name: Warmup endpoints
        run: |
          set -e
          retry() { for i in $(seq 1 30); do curl -fsS "$1" && echo "\nOK: $1" && return 0; echo "Retry $i: $1"; sleep 5; done; return 1; }
          retry http://localhost:8500/product-service/api/products
          retry http://localhost:8700/user-service/api/users
          # Best effort warmups (don't fail pipeline)
          curl -fsS http://localhost:8600/shipping-service/api/shippings || true
          curl -fsS http://localhost:8400/payment-service/api/payments || true
          curl -fsS http://localhost:8300/order-service/api/orders || true
          curl -fsS http://localhost:8800/favourite-service/api/favourites || true

      - name: Run Locust (headless)
        run: |
          locust -f tests/locust/locustfile.py --headless -u 50 -r 10 -t 1m --html locust-report.html --csv locust-results

      - name: Upload Locust report
        uses: actions/upload-artifact@v4
        with:
          name: locust-report
          path: |
            locust-report.html
            locust-results*.csv

      - name: Teardown
        if: always()
        run: |
          set +e
          for pid in /tmp/pf-*.pid; do [ -f "$pid" ] && kill $(cat "$pid") 2>/dev/null || true; done
          kind delete cluster --name dev-e2e
