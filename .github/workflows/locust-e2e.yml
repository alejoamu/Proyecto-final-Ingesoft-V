name: Dev E2E - Locust

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]
  workflow_dispatch: {}

jobs:
  e2e-locust:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Locust deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -r tests/locust/requirements.txt
          python -c "import locust, sys; print('Locust:', locust.__version__)"

      - name: Create kind cluster
        uses: helm/kind-action@v1.9.0
        with:
          cluster_name: dev-e2e
          node_image: kindest/node:v1.30.0

      - name: Create namespace
        run: |
          kubectl get ns ecommerce || kubectl create ns ecommerce

      - name: Apply K8s manifests
        run: |
          kubectl -n ecommerce apply -f k8s/service-discovery.yaml
          kubectl -n ecommerce apply -f k8s/cloud-config.yaml
          kubectl -n ecommerce apply -f k8s/zipkin.yaml || true
          kubectl -n ecommerce apply -f k8s/api-gateway.yaml || true
          kubectl -n ecommerce apply -f k8s/user-service.yaml
          kubectl -n ecommerce apply -f k8s/product-service.yaml
          kubectl -n ecommerce apply -f k8s/order-service.yaml
          kubectl -n ecommerce apply -f k8s/payment-service.yaml
          kubectl -n ecommerce apply -f k8s/shipping-service.yaml
          kubectl -n ecommerce apply -f k8s/favourite-service.yaml
          kubectl -n ecommerce apply -f k8s/proxy-client.yaml || true

      - name: Wait for core infra
        run: |
          set -e
          for d in service-discovery cloud-config; do
            echo "Waiting for $d"
            kubectl -n ecommerce rollout status deploy/$d --timeout=300s || kubectl -n ecommerce get pods -o wide
          done

      - name: Wait for apps
        run: |
          set -e
          for d in user-service product-service order-service payment-service shipping-service favourite-service; do
            echo "Waiting for $d"
            kubectl -n ecommerce rollout status deploy/$d --timeout=360s || kubectl -n ecommerce get pods -o wide
          done

      - name: Wait for service endpoints
        run: |
          set -e
          wait_ep() {
            svc=$1
            for i in $(seq 1 60); do
              ready=$(kubectl -n ecommerce get endpoints "$svc" -o jsonpath='{.subsets[*].addresses[*].ip}' 2>/dev/null || true)
              if [ -n "$ready" ]; then echo "Endpoints ready for $svc: $ready"; return 0; fi
              echo "[$i/60] waiting endpoints for $svc"; sleep 5
            done
            echo "ERROR: endpoints not ready for $svc"; kubectl -n ecommerce get endpoints "$svc" -o wide; exit 1
          }
          for s in product-service user-service shipping-service payment-service order-service favourite-service; do
            wait_ep "$s"
          done

      - name: Port-forward Pods (background)
        run: |
          set -e
          pod_of() {
            # pick the latest Running pod for the app label
            kubectl -n ecommerce get pods -l app="$1" --field-selector=status.phase=Running -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' | tail -n 1
          }
          P_PRODUCT=$(pod_of product-service)
          P_USER=$(pod_of user-service)
          P_SHIP=$(pod_of shipping-service)
          P_PAY=$(pod_of payment-service)
          P_ORDER=$(pod_of order-service)
          P_FAV=$(pod_of favourite-service)
          echo "PF -> product-service: $P_PRODUCT, user-service: $P_USER, shipping: $P_SHIP, payment: $P_PAY, order: $P_ORDER, favourite: $P_FAV"

          # Start port-forwards to pods
          nohup kubectl -n ecommerce port-forward pod/$P_PRODUCT 8500:8500 >/tmp/pf_product.log 2>&1 & echo $! > /tmp/pf_product.pid
          nohup kubectl -n ecommerce port-forward pod/$P_USER 8700:8700     >/tmp/pf_user.log    2>&1 & echo $! > /tmp/pf_user.pid
          nohup kubectl -n ecommerce port-forward pod/$P_SHIP 8600:8600     >/tmp/pf_shipping.log 2>&1 & echo $! > /tmp/pf_shipping.pid
          nohup kubectl -n ecommerce port-forward pod/$P_PAY 8400:8400      >/tmp/pf_payment.log 2>&1 & echo $! > /tmp/pf_payment.pid
          nohup kubectl -n ecommerce port-forward pod/$P_ORDER 8300:8300    >/tmp/pf_order.log   2>&1 & echo $! > /tmp/pf_order.pid
          nohup kubectl -n ecommerce port-forward pod/$P_FAV 8800:8800      >/tmp/pf_favourite.log 2>&1 & echo $! > /tmp/pf_favourite.pid

          # Give port-forwarders time to attach
          sleep 30

          echo "Port-forwarders started. Logs (last 20 lines if any):"
          for f in /tmp/pf_*.log; do echo "==== $f ===="; tail -n 20 "$f" || true; done

      - name: Wait for local ports open
        run: |
          set -e
          wait_port() {
            host=$1; port=$2; label=$3
            for i in $(seq 1 60); do
              if (echo > /dev/tcp/$host/$port) >/dev/null 2>&1; then echo "Port open: $label ($host:$port)"; return 0; fi
              echo "[$i/60] waiting for $label ($host:$port)"; sleep 2
            done
            echo "ERROR: port not open: $label ($host:$port)"; exit 1
          }
          wait_port 127.0.0.1 8500 product-service
          wait_port 127.0.0.1 8700 user-service
          # Best-effort for the rest
          (echo > /dev/tcp/127.0.0.1/8600) >/dev/null 2>&1 || true
          (echo > /dev/tcp/127.0.0.1/8400) >/dev/null 2>&1 || true
          (echo > /dev/tcp/127.0.0.1/8300) >/dev/null 2>&1 || true
          (echo > /dev/tcp/127.0.0.1/8800) >/dev/null 2>&1 || true

      - name: Warmup API endpoints
        run: |
          set -e
          retry() { for i in $(seq 1 60); do curl -fsS "$1" && echo "\nOK: $1" && return 0; echo "Retry $i: $1"; sleep 5; done; return 1; }
          retry http://localhost:8500/api/products
          retry http://localhost:8700/api/users
          # Best effort warmups (don't fail pipeline)
          curl -fsS http://localhost:8600/api/shippings || true
          curl -fsS http://localhost:8400/api/payments || true
          curl -fsS http://localhost:8300/api/orders || true
          curl -fsS http://localhost:8800/api/favourites || true

      - name: Run Locust (headless)
        run: |
          python -m locust -f tests/locust/locustfile.py --host http://localhost --headless -u 50 -r 10 -t 1m --html locust-report.html --csv locust-results

      - name: Upload Locust report
        uses: actions/upload-artifact@v4
        with:
          name: locust-report
          path: |
            locust-report.html
            locust-results*.csv

      - name: Dump diagnostics on failure
        if: failure()
        run: |
          set +e
          kubectl -n ecommerce get pods -o wide
          kubectl -n ecommerce get svc -o wide
          kubectl -n ecommerce get endpoints -o wide
          echo "--- product-service logs (last 100) ---"
          kubectl -n ecommerce logs deploy/product-service --tail=100 || true
          echo "--- user-service logs (last 100) ---"
          kubectl -n ecommerce logs deploy/user-service --tail=100 || true
          for f in /tmp/pf_*.log; do echo "==== $f ===="; tail -n +1 "$f"; done

      - name: Teardown
        if: always()
        run: |
          set +e
          for pid in /tmp/pf_*.pid; do [ -f "$pid" ] && kill $(cat "$pid") 2>/dev/null || true; done
          kind delete cluster --name dev-e2e
